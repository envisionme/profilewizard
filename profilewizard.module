<?php
// $Id$
/**
 * @file
 * Custom module to handle a profile wizard for simplifying the signup process for users
 */
 
/**
 * Implementation of hook_help()
 */
function profilewizard_help($path, $args) {
  if ($path == 'admin/help#profilewizard') {
    $output = '<p>The profile module is a custom module for handling a simple profile wizard for new users</p>';
    return $output;
  }
}

/**
 * Implementation of hook_perm()
 */
function profilewizard_perm() {
  return array('use profile wizard', 'administer profile wizard');
}

/**
 * Implementation of hook_menu()
 */
function profilewizard_menu() {
  $items['admin/settings/profilewizard'] = array(
    'title' => 'Profile Wizard',
    'description' => 'Configure the profile wizard.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('profilewizard_settings_form'),
    'access arguments' => array('administer profile wizard'),
    'file' => 'profilewizard.admin.inc',
  );
  $items['node/%/profilewizard/%'] = array(
    'title' => 'Profile Wizard',
    'page callback' => 'profilewizard_wizard',
    'page arguments' => array(1,3),
    'access callback' => '_profilewizard_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Function to calculate access to menu
 *
 * @return boolean
 *  True if valid
 */
function _profilewizard_access($nid) {
  global $user;
  $node = node_load($nid);
  return $user && $user->uid &&
  (
    // The user is not blocked and logged in at least once.
    ($user->access && $user->status && ((user_access('use profile wizard') && $node->uid == $user->uid) || user_access('administer profile wizard')))
  );
}

/**
 * Implementation of hook_block()
 */
function profilewizard_block($op='list', $delta=0, $edit=array()) {
  switch($op) {
    case 'list':
      $block[0]['info'] = t('Profile Wizard');
      return $block;
    case 'view':
      $blocks['subject'] = t('');
      $blocks['content'] = _profilewizard_block();
      return $blocks;
  }
}

/**
 * Check if the user needs to use the profile wizard and provides the button to start the process
 *
 * @return string
 *  String with link to wizard
 */
function _profilewizard_block() {
  global $user;
	// if not on the step process display link to 1st step page
	if (user_access('use profile wizard') && (arg(0) == 'node' && arg(2) != 'profilewizard' && !is_numeric(arg(3)))) {
    return l('Profile Wizard', 'profilewizard/step/1');
  }
	
	// add stylesheet
	drupal_add_css(drupal_get_path('module', 'profilewizard').'/profilewizard.css');
	
	$node = node_load((int)arg(1));
	$step = (int)arg(3);
	$type = variable_get('profilewizard_type', null);
	$steps = variable_get('profilewizard_steps', null);
	
	$output = '';
	$step_list = array();
	if ($type == $node->type)
	// iterate through all steps and print label links
	for($i = 1; $i <= $steps; $i++) {
		$label = variable_get('profilewizard_label_step'.$i, null);
		$step_list[] = l($label == null?'Step '.$i:$label, 'node/'.$node->nid.'/profilewizard/'.$i);
	}
	$output = theme_item_list($step_list, null, 'ol');
	return $output;
}

/**
 * Callback returning the the correct form
 *
 * @return
 *  String data
 */
function profilewizard_wizard($nid, $step) {
  $output = '';
  // module_load_include('inc', 'node', 'node.pages');
  $node = node_load($nid);
  // redirect if not the chosen wizard type
  if ($node->type != variable_get('profilewizard_type', null)) {
    drupal_not_found();
		exit();
	}
	drupal_set_title(variable_get('profilewizard_label_step'.$step, null));
  $output .= drupal_get_form('profilewizard_step_form', $node, $step);
  return $output;
}

/**
 * Implementation of step form
 */
function profilewizard_step_form($context, $node, $step) {
  $output = '';
  $form_id = $node->type.'_node_form';
  $form_state = array();
  $fields = variable_get('profilewizard_fields_step'.$step, null);
	
  // clean list of fields to show
  foreach($fields as $key => $field) {
     if ($field == null)
      unset($fields[$key]);
  }
  
  module_load_include('inc', 'node', 'node.pages'); 
  if (module_exists('filefield'))
		module_load_include('inc', 'filefield', 'filefield_widget');
  if (module_exists('imagefield'))
		module_load_include('inc', 'imagefield', 'imagefield_widget');
  
  // Initialize settings:
  $form = drupal_retrieve_form($form_id, $form_state, $node);
  unset($form['buttons']['preview']);
  unset($form['buttons']['delete']);
	unset($form['buttons']['submit']);
	if ($step > 1)
	$form['buttons']['prev'] = array(
    '#type' => 'submit',
		'#access' => 1,
    '#value' => t('Previous'),
    '#weight' => 9,
    '#submit' => array('profilewizard_step_form_submit')
	);
	$form['buttons']['next'] = array(
    '#type' => 'submit',
		'#access' => 1,
    '#value' => $step == variable_get('profilewizard_steps', null)?t('Finish'):t('Next'),
    '#weight' => 10,
    '#submit' => array('profilewizard_step_form_submit')
	);
	$form['buttons']['skip'] = array(
    '#type' => 'submit',
		'#access' => 1,
    '#value' => t('Skip Process'),
    '#weight' => 11,
    '#submit' => array('profilewizard_step_form_submit')
	);
	
  drupal_prepare_form($form_id, $form, $form_state);
  // print_r($form['buttons']);
  
  // save all file field prepare data because they conflict after form processing
  $prepare_fields = array();
  $prepare_types = array('filefield_widget', 'imagefield_widget', 'imagefield_crop_widget');
	
  foreach($fields as $field) {
    // Update the cached form with the new element at the right place in the form.
		if (module_exists('fieldgroup') && ($group_name = _fieldgroup_field_get_group($node->type, $field))) {
				$prepare_fields[$field] = $form[$group_name][$field];
		} else {
		// if (in_array($form[$field][0]['#type'], $prepare_types))
      $prepare_fields[$field] = $form[$field];
		}
  }
	
  
  drupal_process_form($form_id, $form, $form_state);
  
  // restore all filefield prepare data because of conflict
	foreach($fields as $field) {
		// Update the cached form with the new element at the right place in the form.
		$form[$field] = $prepare_fields[$field];
  }

	$field_keys = array('#id', 'nid', 'vid', 'uid', 'created', 'type', 'language', 'changed', 'buttons', '#node', '#validate', '#theme', '#parameters', '#type', '#programmed', '#token', 'form_token', 'form_id', '#method', '#action', '#description', '#attributes', '#required', '#tree', '#parents', '#cache', '#pre_render', '#content_extra_fields', '#processed', '#defaults_loaded', '#field_info', '#build_id', 'form_build_id');
  
  // hide unwanted fields
	foreach($form as $key => $field) {
		if (!in_array($key, $field_keys) && !in_array($key, $fields)) {
			unset($form[$key]);
		}
	}
  
	// hide defaults
  $form['author']['#type'] = 'hidden';
  $form['options']['#type'] = 'hidden';
  $form['comment_settings']['#type'] = 'hidden';
  $form['path']['#type'] = 'hidden';
  $form['path_redirect']['#type'] = 'hidden';
  $form['print']['#type'] = 'hidden';
  $form['path']['#type'] = 'hidden';
  $form['path']['#type'] = 'hidden';
  $form['notifications']['#type'] = 'hidden';
	
	// pass form step number
	$form['profilewizard']['step'] = array(
		'#type' => 'value',
		'#value' => $step,
	);
	
	// set up redirect
	return $form;
}

/**
 * Implementation of step 1 form submit
 */
function profilewizard_step_form_submit($form, &$form_state) {
  // echo '<pre>'.print_r($form_state, 1).'</pre>';
	// redirect to home page if skip button clicked
	if ($form_state['clicked_button']['#value'] == 'Skip Process') {
		$form_state['redirect'] = '';
		return;
	}
	$step = (int)$form_state['values']['step'];
  $node = node_load($form_state['values']['nid']);
  
  $form_id = $node->type.'_node_form';
  $form_state_new = array();
  $values = array();
	module_load_include('inc', 'node', 'node.pages');
	module_load_include('inc', 'filefield', 'filefield_widget');
  module_load_include('inc', 'imagefield', 'imagefield_widget');
  module_load_include('inc', 'content', 'includes/content.crud');
  // get fields from settings page
  $fields = variable_get('profilewizard_fields_step'.$step, null) ;
  foreach($fields as $field) {
    $values[$field] = $form_state['values'][$field];
  }
  $values['op'] = t('Save');
  $form_state_new['values'] = $values;
  $form_state_new['node'] = (array)$node;
  
  if ($form_state['clicked_button']['#value'] == 'Next' || $form_state['clicked_button']['#value'] == 'Finish')
		drupal_execute($form_id, $form_state_new, (object)$node);
  // drupal_flush_all_caches();
	if (($form_state['clicked_button']['#value'] == 'Next' || $form_state['clicked_button']['#value'] == 'Finish') && $step < variable_get('profilewizard_steps', null))
		$form_state['redirect'] = 'node/'.$node->nid.'/profilewizard/'.($step+1);
	elseif ($form_state['clicked_button']['#value'] == 'Previous' && $step > 1)
		$form_state['redirect'] = 'node/'.$node->nid.'/profilewizard/'.($step-1);
	elseif ($step == variable_get('profilewizard_steps', null))
		$form_state['redirect'] = '';
}

/**
 * get UID from url (user, company and node pages)
 *
 * @return number
 *  apropriate UID
 */
function get_uid_from_url() {
  // return uid for normal pages
  if (arg(0) == 'user' && is_numeric(arg(1)))
    return arg(1);
  // return admin page holder uid
  if (arg(0) == 'user' && (arg(1) == null || arg(1) == 'admin') || arg(0) == 'recruiter' && arg(1) == 'admin' || arg(0) == 'company' && arg(1) == 'admin' || arg(0) == 'usersearch') {
    global $user;
    return $user->uid;
  }
  // return company uid
  if (arg(0) == 'company' && is_numeric(arg(1)))
    return arg(1);
  // return node author
  if (arg(0) == 'node' && is_numeric(arg(1))) {
    $node = node_load(arg(1));
    if ($node->type == 'page')
      return false;
    if ($node->type != 'reference')
      return $node->uid;
    else {
      return $node->field_user[0][uid];
    }
  }
  if (arg(0) == 'node' && arg(1) == 'add') {
    global $user;
    return $user->uid;
  }
  return false;
}

/**
 * get user image from $uid
 *
 * @return string
 *  Themed image output
 */
function get_user_image($uid = null, $preset = 'thumb-mini') {
  global $user;
  if ($uid == null)
    $uid = $user->uid;

  $user_tmp = user_load($uid);
  $image_path = $user_tmp->picture;
  if(in_array("applicant", $user_tmp->roles)) {
    if (!$image_path || !file_exists($image_path)) {
      // $result = db_query('SELECT nid FROM {node} n WHERE type = \'%s\' AND n.uid = %d LIMIT %d', 'uprofile', $user_tmp->uid, 1);
      // $result = db_fetch_object($result);
      $user_profile = get_user_profile($uid);
      if ($user_profile->field_gender[0]['value'] == 'Male')
        $image_path = 'sites/default/files/default-image-m.jpg';
      elseif ($user_profile->field_gender[0]['value'] == 'Female')
        $image_path = 'sites/default/files/default-image-f.jpg';
      else
        $image_path = 'sites/default/files/default-image.jpg';
    }
  } elseif (in_array("company", $user_tmp->roles)) {
    $user_profile = get_user_profile($uid);
    // if (file_exists($user_profile->field_company_logo[0]['filepath']))
      // $image_path = $user_profile->field_company_logo[0]['filepath'];
    // else
      $image_path = 'sites/default/files/default-image.jpg';
    // if ($preset == 'thumb-mini') 
      // $preset = 'company-mini';
  }
  return theme('imagecache', $preset, $image_path, 'View Profile', 'View Profile');
}

/**
 * get user profile from $uid
 *
 * @return object
 *  Node containing user profile
 */
function get_user_profile($uid = null) {
  global $user;
  if ($uid == null)
    $uid = $user->uid;

  $user_tmp = user_load($uid);
  if (in_array('applicant', $user_tmp->roles)) {
    $result = db_query('SELECT nid FROM {node} n WHERE type = \'%s\' AND n.uid = %d LIMIT %d', 'uprofile', $user_tmp->uid, 1);
  } elseif (in_array('company', $user_tmp->roles)) {
    $result = db_query('SELECT nid FROM {node} n WHERE type = \'%s\' AND n.uid = %d LIMIT %d', 'company', $user_tmp->uid, 1);
  }
  $result = db_fetch_object($result);
  return node_load($result->nid);
}

/**
 * get current position of applicant
 * @param $uid Integer
 *  to indicate UID of applicant
 */
function get_current_position($uid = null) {
  global $user;
  if ($uid == null)
    $uid = $user->uid;

  $user_tmp = user_load($uid);
  // check if user is an applicant and exit if not
  if (!in_array('applicant', $user_tmp->roles))
    return;
  
  $profile = get_user_profile($uid);
  $current_position = array();
  // print_r($profile);
  if (!empty($profile->field_app_job_history))
  foreach($profile->field_app_job_history as $job) {
    // print_r($job);
    if ($job['todate'] == 'Current') {
      $current_position['company'] = $job['company'];
      $current_position['position'] = $job['position'];
      return $current_position;
    }
  }
  return array('company' => '', 'position' => 'Currently Unemployed');
}
